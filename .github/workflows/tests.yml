name: Tests et Évaluation Continue

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  

jobs:
  tests-unitaires:
    name: Tests Unitaires
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.11']
    
    steps:
    - name: Checkout du code
      uses: actions/checkout@v4
    
    - name: Configuration Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: Installation des dépendances
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install pytest pytest-cov pytest-mock pytest-asyncio
    
    - name: Exécution des tests unitaires
      run: |
        pytest -m "unit" --cov=src --cov-report=xml --cov-report=term -v --junitxml=unit-tests.xml
    
    - name: Upload de la couverture vers Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
    
    - name: Upload du rapport de couverture
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-xml
        path: coverage.xml
        retention-days: 7
    
    - name: Upload des résultats unitaires
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: junit-unit
        path: unit-tests.xml
        retention-days: 7

  tests-fonctionnels:
    name: Tests Fonctionnels (API)
    runs-on: ubuntu-latest
    needs: tests-unitaires
    
    steps:
    - name: Checkout du code
      uses: actions/checkout@v4
    
    - name: Configuration Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Installation des dépendances
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install pytest requests
    
    - name: Démarrage de l'API
      run: |
        nohup python -m uvicorn api.main:app --host 127.0.0.1 --port 8000 > uvicorn.log 2>&1 &
    
    - name: Attente du démarrage de l'API
      run: |
        for i in {1..30}; do
          if curl -s http://127.0.0.1:8000/health > /dev/null; then
            echo "API prête"
            exit 0
          fi
          sleep 2
        done
        echo "API non disponible"
        echo "Logs:"
        tail -n 200 uvicorn.log || true
        exit 1
    
    - name: Exécution des tests fonctionnels
      run: |
        pytest -m "functional" -v --junitxml=functional-tests.xml
    
    - name: Upload des résultats fonctionnels
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: junit-functional
        path: functional-tests.xml
        retention-days: 7

  rapport-qualite:
    name: Résumé des tests
    runs-on: ubuntu-latest
    needs: [tests-unitaires, tests-fonctionnels]
    if: always()
    
    steps:
    - name: Télécharger la couverture
      uses: actions/download-artifact@v4
      with:
        name: coverage-xml
        path: artifacts
    
    - name: Télécharger les résultats unitaires
      uses: actions/download-artifact@v4
      with:
        name: junit-unit
        path: artifacts
    
    - name: Télécharger les résultats fonctionnels
      uses: actions/download-artifact@v4
      with:
        name: junit-functional
        path: artifacts
    
    - name: Génération du résumé des tests
      run: |
        echo "Pipeline de qualité complété" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Résumé des tests" >> $GITHUB_STEP_SUMMARY
        echo "- Tests unitaires: ${{ needs.tests-unitaires.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Tests fonctionnels: ${{ needs.tests-fonctionnels.result }}" >> $GITHUB_STEP_SUMMARY
        
        if [ -f artifacts/coverage.xml ]; then
          python - <<'PY' >> $GITHUB_STEP_SUMMARY
        import xml.etree.ElementTree as ET
        tree = ET.parse("artifacts/coverage.xml")
        root = tree.getroot()
        line_rate = root.attrib.get("line-rate")
        if line_rate is not None:
            pct = float(line_rate) * 100
            print(f"- Couverture: {pct:.2f}%")
        else:
            print("- Couverture: indisponible")
        PY
        else
          echo "- Couverture: indisponible" >> $GITHUB_STEP_SUMMARY
        fi
        
        python - <<'PY' >> $GITHUB_STEP_SUMMARY
        import xml.etree.ElementTree as ET
        from pathlib import Path
        
        def line(label, tests, failures, errors, skipped):
            passed = tests - failures - errors - skipped
            print(f"- {label}: {passed} passed, {failures} failed, {errors} errors, {skipped} skipped, {tests} total")
        
        def read(path, label):
            if not Path(path).exists():
                print(f"- {label}: indisponible")
                return
            root = ET.parse(path).getroot()
            tests = int(root.attrib.get("tests", 0))
            failures = int(root.attrib.get("failures", 0))
            errors = int(root.attrib.get("errors", 0))
            skipped = int(root.attrib.get("skipped", 0))
            line(label, tests, failures, errors, skipped)
        
        read("artifacts/unit-tests.xml", "Unitaires")
        read("artifacts/functional-tests.xml", "Fonctionnels")
        PY
